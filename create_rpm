#!/bin/sh
curdir=`pwd`
ver=$(cat conf-version)
cd ..
/bin/rm -rf /tmp/libqmail-"$vers"
cp -rp libqmail /tmp/libqmail-"$ver"
cd /tmp/libqmail-"$ver"
make clean
make distclean
if test -f $HOME/.rpmmacros
then
	topdir=`grep ^%_topdir $HOME/.rpmmacros | awk '{print $2}'`
	if test -n "$topdir"
	then
		rpmbuild=$topdir
	else
		rpmbuild=$HOME/rpmbuild
	fi
else
	rpmbuild=$HOME/rpmbuild
fi
/bin/rm -rf autom4te.cache .deps
cd ..
tar \
	--exclude="libqmail-$ver/.git" \
	--exclude="libqmail-$ver/debian"  \
	--exclude="libqmail-$ver/RCS" \
	-cf - libqmail-"$ver" \
	| gzip -c > $rpmbuild/SOURCES/libqmail-"$ver".tar.gz
if [ -d /usr/include/qmail ] ; then
	version=$(rpm -qf /usr/include/qmail|cut -d- -f3)
	if [ "$version" = "$ver" ] ; then
		release=$(rpm -qf /usr/include/qmail | cut -d- -f4 | cut -d. -f2)
		release=$(expr $release + 1)
	else
		release=1
	fi
else
	release=1
fi
cd /tmp/libqmail-"$ver"
sed -i -e "s|^Release: .*|Release: 1.$release%{?dist}|g" libqmail.spec
rpmbuild -ba --clean libqmail.spec
cd $curdir
if [ $? -eq 0 ] ; then
	echo 1.$release > conf-release
	cd debian
	make
fi
