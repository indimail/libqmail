#!/bin/sh
ver=0.1
cd ..
if [ -d libqmail-"$ver" ] ; then
	cp -rp libqmail-"$ver" /tmp
	cd /tmp/libqmail-"$ver"
else
	echo "libqmail-"$ver": No such file or directory" 1>&2
	exit 1
fi
make clean
make distclean
if test -f $HOME/.rpmmacros
then
	topdir=`grep ^%_topdir $HOME/.rpmmacros | awk '{print $2}'`
	if test -n "$topdir"
	then
		rpmbuild=$topdir
	else
		rpmbuild=$HOME/rpmbuild
	fi
else
	rpmbuild=$HOME/rpmbuild
fi
/bin/rm -rf autom4te.cache .deps
cd ..
tar \
	--exclude="libqmail-$ver/.git" \
	--exclude="libqmail-$ver/debian"  \
	--exclude="libqmail-$ver/RCS" \
	-cf - libqmail-"$ver" \
	| gzip -c > $rpmbuild/SOURCES/libqmail-"$ver".tar.gz
if [ -d /usr/include/qmail ] ; then
	release=$(rpm -qf /usr/include/qmail | cut -d- -f4 | cut -d. -f1)
	release=$(expr $release + 1)
else
	release=1
fi
cd libqmail-"$ver"
sed -i -e "s|^Release: .*|Release: $release.1%{?dist}|g" libqmail.spec
rpmbuild -ba --clean libqmail.spec
