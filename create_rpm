#!/bin/sh
curdir=`pwd`
ver=$(cat conf-version)
cd ..
/bin/rm -rf /tmp/libqmail-"$vers"
cp -rp libqmail /tmp/libqmail-"$ver"
cd /tmp/libqmail-"$ver"
make clean
make distclean
if test -f $HOME/.rpmmacros
then
	topdir=`grep ^%_topdir $HOME/.rpmmacros | awk '{print $2}'`
	if test -n "$topdir"
	then
		rpmbuild=$topdir
	else
		rpmbuild=$HOME/rpmbuild
	fi
else
	rpmbuild=$HOME/rpmbuild
fi
/bin/rm -rf autom4te.cache .deps
cd ..
tar \
	--exclude="libqmail-$ver/.git" \
	--exclude="libqmail-$ver/debian"  \
	--exclude="libqmail-$ver/RCS" \
	-cf - libqmail-"$ver" \
	| gzip -c > $rpmbuild/SOURCES/libqmail-"$ver".tar.gz
if [ -d /usr/include/qmail ] ; then
	version=$(rpm -qf /usr/include/qmail|cut -d- -f3)
	if [ "$version" = "$ver" ] ; then
		release=$(rpm -qf /usr/include/qmail | cut -d- -f4 | cut -d. -f2)
		release=$(expr $release + 1)
	else
		release=1
	fi
else
	release=1
fi
echo -n "Build RPM for libqmail-"$ver"-1."$release" (Y/N) - "
read key
if [ " $key" = " Y" -o " $key" = " y" ] ; then
	cp /tmp/libqmail-"$ver"/libqmail.spec /tmp
	/bin/rm -rf /tmp/libqmail-"$ver"
	sed -i -e "s|^Release: .*|Release: 1.$release%{?dist}|g" /tmp/libqmail.spec
	rpmbuild -ba --clean /tmp/libqmail.spec
	cd $curdir
	if [ $? -eq 0 ] ; then
		echo 1.$release > conf-release
		cd debian
		make
	fi
	build_arch=`rpmbuild --showrc|grep "^build arch" | awk '{print $4}'`
	dist=`uname -r |cut -d . -f4`
	rpm --addsign $rpmbuild/RPMS/$build_arch/libqmail-"$ver"-"1.$release".$dist.$build_arch.rpm
else
	/bin/rm -rf /tmp/libqmail-"$ver"
fi
echo -n "Remove Source (Y/N) - "
read key
if [ " $key" = " Y" -o " $key" = " y" ] ; then
	/bin/rm -f $rpmbuild/SOURCES/libqmail-"$ver".tar.gz
fi
